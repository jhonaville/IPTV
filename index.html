<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login con PIN</title>
<style>
  body { font-family: Arial, sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; margin:0; background:#f2f2f2;}
  .login-box { background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.2); text-align:center; }
  h2 { margin-bottom:10px; }
  .pin-display { font-size:24px; letter-spacing:10px; margin:10px 0; min-height:30px; }
  .keypad { display:grid; grid-template-columns:repeat(3,60px); gap:10px; justify-content:center; margin-top:10px; }
  .key { background:#007bff; color:#fff; font-size:20px; padding:15px; border-radius:5px; cursor:pointer; user-select:none; }
  .key:active { background:#0056b3; }
  .action { background:#28a745; grid-column:span 3; margin-top:10px; }
  .message { margin-top:10px; color:red; min-height:20px; }
</style>
</head>
<body>

<div class="login-box">
  <h2>Ingrese su PIN</h2>
  <div class="pin-display" id="pinDisplay"></div>
  <div class="keypad" id="keypad"></div>
  <div class="message" id="message"></div>
</div>

<script>
const PIN_HASH = "ef92b778ba5c53fa2b3f96b2f3edaf0b2f06cbbff8ff33e8fa64e49e11c2f5c4"; // Hash simulado de '1234' con SHA-256
let enteredPin = [];
const maxDigits = 4;
let attempts = 0;
const maxAttempts = 3;

const pinDisplay = document.getElementById('pinDisplay');
const keypad = document.getElementById('keypad');
const message = document.getElementById('message');

// Función para mezclar números aleatoriamente
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// Generar teclado
function generateKeypad() {
  keypad.innerHTML = '';
  let numbers = shuffleArray([0,1,2,3,4,5,6,7,8,9]);
  numbers.forEach(num => {
    const key = document.createElement('div');
    key.className = 'key';
    key.textContent = num;
    key.onclick = () => pressKey(num);
    keypad.appendChild(key);
  });

  // Botón de borrar
  const clearKey = document.createElement('div');
  clearKey.className = 'key action';
  clearKey.textContent = 'BORRAR';
  clearKey.onclick = () => { enteredPin = []; updateDisplay(); message.textContent=''; };
  keypad.appendChild(clearKey);
}

// Mostrar PIN ingresado (solo asteriscos)
function updateDisplay() {
  pinDisplay.textContent = '*'.repeat(enteredPin.length);
}

// Función al presionar número
function pressKey(num) {
  if (enteredPin.length < maxDigits) {
    enteredPin.push(num);
    updateDisplay();
    if (enteredPin.length === maxDigits) validatePin();
  }
}

// Función de validación
async function validatePin() {
  const entered = enteredPin.join('');
  const encoder = new TextEncoder();
  const data = encoder.encode(entered);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2,'0')).join('');

  if (hashHex === PIN_HASH) {
    message.style.color = 'green';
    message.textContent = 'Acceso permitido';
    // Aquí rediriges según rol
  } else {
    attempts++;
    message.style.color = 'red';
    if (attempts >= maxAttempts) {
      message.textContent = 'Máximo intentos alcanzado. Bloqueado 30s';
      keypad.querySelectorAll('.key').forEach(k => k.onclick = null);
      setTimeout(() => { attempts=0; enteredPin=[]; updateDisplay(); generateKeypad(); message.textContent=''; }, 30000);
    } else {
      message.textContent = `PIN incorrecto. Intentos restantes: ${maxAttempts - attempts}`;
      enteredPin = [];
      updateDisplay();
      generateKeypad();
    }
  }
}

generateKeypad();
</script>

</body>
</html>
