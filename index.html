<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner Android OK</title>

<style>
body {
  text-align:center;
  font-family: Arial;
  background:#111;
  color:white;
}

#container {
  position:relative;
  display:inline-block;
  width:90%;
  max-width:400px;
  margin-top:20px;
}

video {
  width:100%;
  border-radius:10px;
}

#laser {
  position:absolute;
  left:0;
  width:100%;
  height:3px;
  background:red;
  box-shadow:0 0 10px red;
  animation: scan 2s linear infinite;
}

@keyframes scan {
  0% { top:0; }
  50% { top:95%; }
  100% { top:0; }
}

#result {
  font-size:20px;
  margin-top:20px;
  min-height:30px;
}

button {
  padding:10px 20px;
  font-size:16px;
  border:none;
  border-radius:8px;
  background:#00c853;
  color:white;
}

.detected {
  color:#00ff88;
  font-weight:bold;
}
</style>
</head>

<body>

<h2>üì∑ Scanner con Sonido (Android Fix)</h2>

<button onclick="iniciar()">Iniciar c√°mara</button>

<div id="container">
  <video id="video" autoplay playsinline></video>
  <div id="laser"></div>
</div>

<p id="result">Presiona iniciar</p>

<script>
const video = document.getElementById("video");
const result = document.getElementById("result");

let lastCode = "";
let detecting = false;
let audioCtx;

// üîä Inicializar audio SOLO despu√©s de interacci√≥n
function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

// üéµ Beep compatible Android
function beep() {
  if (!audioCtx) return;

  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.type = "sine";
  oscillator.frequency.value = 1200;
  gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);

  oscillator.start();
  oscillator.stop(audioCtx.currentTime + 0.15);
}

async function iniciar() {

  try {

    initAudio(); // üî• ACTIVAR AUDIO

    if (!("BarcodeDetector" in window)) {
      result.textContent = "‚ùå BarcodeDetector NO soportado";
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    video.srcObject = stream;

    const detector = new BarcodeDetector({
      formats: ["ean_13", "ean_8", "code_128", "qr_code"]
    });

    result.textContent = "üîç Escaneando...";

    async function detectar() {

      if (video.readyState === video.HAVE_ENOUGH_DATA) {

        try {
          const codes = await detector.detect(video);

          if (codes.length > 0) {

            const code = codes[0].rawValue;

            if (code !== lastCode && !detecting) {

              detecting = true;
              lastCode = code;

              result.textContent = "‚úÖ C√≥digo: " + code;
              result.classList.add("detected");

              beep();

              if (navigator.vibrate) {
                navigator.vibrate(200);
              }

              setTimeout(() => {
                detecting = false;
                result.classList.remove("detected");
              }, 1500);
            }
          }

        } catch (err) {
          console.log(err);
        }
      }

      requestAnimationFrame(detectar);
    }

    detectar();

  } catch (error) {
    result.textContent = "‚ùå Error accediendo a c√°mara";
    console.error(error);
  }
}
</script>

</body>
</html>

</body>
</html>
