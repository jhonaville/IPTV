<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner Mejorado</title>

<style>
body {
  text-align:center;
  font-family: Arial;
  background:#111;
  color:white;
}

#container {
  position:relative;
  display:inline-block;
  width:90%;
  max-width:400px;
}

video {
  width:100%;
  border-radius:10px;
}

#laser {
  position:absolute;
  left:0;
  width:100%;
  height:3px;
  background:red;
  box-shadow:0 0 10px red;
  animation: scan 2s linear infinite;
}

@keyframes scan {
  0% { top:0; }
  50% { top:95%; }
  100% { top:0; }
}

#result {
  font-size:20px;
  margin-top:20px;
  min-height:30px;
}

.detected {
  color:#00ff88;
  font-weight:bold;
}
</style>
</head>

<body>

<h2>üì∑ Scanner con Sonido</h2>

<div id="container">
  <video id="video" autoplay playsinline></video>
  <div id="laser"></div>
</div>

<p id="result">Iniciando c√°mara...</p>

<script>
const video = document.getElementById("video");
const result = document.getElementById("result");

let lastCode = "";
let detecting = false;

// üéµ Crear beep simple
function beep() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = ctx.createOscillator();
  const gainNode = ctx.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(ctx.destination);

  oscillator.type = "sine";
  oscillator.frequency.value = 1000;
  gainNode.gain.value = 0.1;

  oscillator.start();
  setTimeout(() => {
    oscillator.stop();
    ctx.close();
  }, 150);
}

async function iniciar() {

  try {

    if (!("BarcodeDetector" in window)) {
      result.textContent = "‚ùå BarcodeDetector NO soportado en este navegador";
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    video.srcObject = stream;

    const detector = new BarcodeDetector({
      formats: ["ean_13", "ean_8", "code_128", "qr_code"]
    });

    result.textContent = "üîç Escaneando...";

    async function detectar() {

      if (video.readyState === video.HAVE_ENOUGH_DATA) {

        try {
          const codes = await detector.detect(video);

          if (codes.length > 0) {

            const code = codes[0].rawValue;

            if (code !== lastCode && !detecting) {

              detecting = true;
              lastCode = code;

              result.textContent = "‚úÖ C√≥digo: " + code;
              result.classList.add("detected");

              beep();

              if (navigator.vibrate) {
                navigator.vibrate(200);
              }

              setTimeout(() => {
                detecting = false;
                result.classList.remove("detected");
              }, 1500);
            }
          }

        } catch (err) {
          console.log("Error detectando:", err);
        }
      }

      requestAnimationFrame(detectar);
    }

    detectar();

  } catch (error) {
    result.textContent = "‚ùå Error accediendo a c√°mara";
    console.error(error);
  }
}

iniciar();
</script>

</body>
</html>
